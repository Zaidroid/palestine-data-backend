name: Notify on Data Update Failure

on:
  workflow_run:
    workflows:
      - "Update Data"
      - "Update Real-Time Data Sources"
      - "Update Daily Data Sources"
      - "Update Weekly Data Sources"
      - "Update Monthly Data Sources"
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = '${{ github.event.workflow_run.name }}';
            const runUrl = '${{ github.event.workflow_run.html_url }}';
            const conclusion = '${{ github.event.workflow_run.conclusion }}';
            
            // Check if an open issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['data-update-failure', 'automated'],
              state: 'open'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes(workflowName)
            );
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ðŸ”´ Another Failure Detected\n\n**Workflow**: ${workflowName}\n**Run**: ${runUrl}\n**Time**: ${new Date().toISOString()}\n\nThe workflow is still failing. Please investigate.`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”´ Data Update Failure: ${workflowName}`,
                labels: ['data-update-failure', 'automated', 'bug'],
                body: `## ðŸš¨ Data Update Workflow Failed\n\n**Workflow**: ${workflowName}\n**Status**: ${conclusion}\n**Run URL**: ${runUrl}\n**Time**: ${new Date().toISOString()}\n\n### Details\n\nThe automated data update workflow has failed. Please:\n\n1. Check the [workflow run logs](${runUrl})\n2. Identify the failing data source\n3. Fix the issue\n4. Re-run the workflow manually\n\n### Common Issues\n\n- API rate limits exceeded\n- Network connectivity problems\n- Data source API changes\n- Invalid data format\n- Validation errors\n\n### Next Steps\n\n- [ ] Review workflow logs\n- [ ] Identify root cause\n- [ ] Apply fix\n- [ ] Test locally with \`npm run update-data\`\n- [ ] Close this issue when resolved\n\n---\n*This issue was automatically created by the notification system.*`
              });
            }
      
      - name: Notify via summary
        run: |
          echo "## ðŸ”´ Workflow Failure Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow**: ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ github.event.workflow_run.conclusion }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: ${{ github.event.workflow_run.html_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "An issue has been created to track this failure." >> $GITHUB_STEP_SUMMARY