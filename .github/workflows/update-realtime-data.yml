name: Update Real-Time Data Sources

# Run every 6 hours for real-time data sources (Tech4Palestine)
on:
  schedule:
    # Runs at 00:00, 06:00, 12:00, 18:00 UTC daily
    - cron: '0 */6 * * *'
  
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  update-realtime-data:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # 3. Install dependencies
      - name: Install dependencies
        run: npm ci
      
      # 4. Fetch Tech4Palestine data (inline in fetch-all-data.js)
      - name: Fetch Tech4Palestine data
        run: node scripts/fetch-all-data.js
        env:
          NODE_ENV: production
        continue-on-error: true
      
      # 5. Transform to unified format
      - name: Populate unified data
        run: npm run populate-unified
        continue-on-error: true
      
      # 6. Run data validation
      - name: Validate data quality
        run: node scripts/validate-data.js
        continue-on-error: true
      
      # 7. Check if data changed
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet data/tech4palestine/ data/unified/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "ℹ️ No data changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "✅ Data changes detected"
            # Show what changed
            git diff --stat data/tech4palestine/ data/unified/
          fi
      
      # 8. Commit and push if data changed
      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.name "Real-Time Data Bot"
          git config --local user.email "realtime-bot@palboard.net"
          git add data/tech4palestine/
          git add data/unified/
          git add data/manifest.json
          git add data/validation-report.json
          git add data/data-collection-summary.json
          git commit -m "🤖 Auto-update real-time data (Tech4Palestine + Unified): $(date -u '+%Y-%m-%d %H:%M UTC')"
          git push
      
      # 9. Summary
      - name: Summary
        run: |
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "✅ Real-time data updated and pushed to repository"
            echo "📊 Netlify will automatically deploy the changes"
            echo "📈 Data sources: Tech4Palestine"
            echo "🔄 Unified data transformed and enriched"
          else
            echo "ℹ️ No data changes - skipping commit"
          fi
      
      # 10. Upload validation report as artifact
      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-report-realtime
          path: data/validation-report.json
          retention-days: 7
      
      # 11. Upload summary report as artifact
      - name: Upload summary report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: summary-report-realtime
          path: data/data-collection-summary.json
          retention-days: 7
