
> palestine-data-backend@1.0.0 test
> node --experimental-vm-modules node_modules/jest/bin/jest.js --verbose

  console.log
    Mocking searchService.js

      at tests/api.test.js:6:13

(node:23912) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
[0mGET /api/v1/health [32m200[0m 8.014 ms - 54[0m
[0mGET /api/v1/unified/conflict?limit=5 [32m200[0m 14.292 ms - -[0m
[0mGET /api/v1/unified/unknown-category [33m404[0m 1.450 ms - 30[0m
[0mGET /api/v1/search?q=gaza [31m503[0m 0.845 ms - 68[0m
[0mGET /api/v1/search [33m400[0m 0.447 ms - 45[0m
FAIL tests/api.test.js
  API Endpoints
    GET /api/v1/health
      âˆš should return 200 OK (30 ms)
    GET /api/v1/unified/conflict
      âˆš should return 200 or 404 depending on data existence (19 ms)
      âˆš should return 404 for unknown category (4 ms)
    GET /api/v1/search
      Ã— should return 200 for search query (10 ms)
      âˆš should return 400 if query is missing (4 ms)

  â— API Endpoints â€º GET /api/v1/search â€º should return 200 for search query

    expect(received).toEqual(expected) // deep equality

    Expected: 200
    Received: 503

    [0m [90m 42 |[39m         it([32m'should return 200 for search query'[39m[33m,[39m [36masync[39m () [33m=>[39m {
     [90m 43 |[39m             [36mconst[39m res [33m=[39m [36mawait[39m request(app)[33m.[39m[36mget[39m([32m'/api/v1/search?q=gaza'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 44 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoEqual([35m200[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 45 |[39m             expect([33mArray[39m[33m.[39misArray(res[33m.[39mbody))[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 46 |[39m         })[33m;[39m
     [90m 47 |[39m[0m

      at Object.<anonymous> (tests/api.test.js:44:36)

FAIL tests/transformers.test.js
  ConflictTransformer
    Ã— should transform a standard conflict record (1 ms)
    Ã— should handle missing fields gracefully

  â— ConflictTransformer â€º should transform a standard conflict record

    TypeError: Cannot read properties of undefined (reading 'source')

    [0m [90m 76 |[39m       [90m// Provenance[39m
     [90m 77 |[39m       sources[33m:[39m [{
    [31m[1m>[22m[39m[90m 78 |[39m         name[33m:[39m metadata[33m.[39msource [33m||[39m metadata[33m.[39morganization[33m?[39m[33m.[39mtitle [33m||[39m [32m'Unknown'[39m[33m,[39m
     [90m    |[39m                        [31m[1m^[22m[39m
     [90m 79 |[39m         organization[33m:[39m metadata[33m.[39morganization[33m?[39m[33m.[39mtitle [33m||[39m metadata[33m.[39morganization [33m||[39m [32m'Unknown'[39m[33m,[39m
     [90m 80 |[39m         fetched_at[33m:[39m [36mnew[39m [33mDate[39m()[33m.[39mtoISOString()[33m,[39m
     [90m 81 |[39m         url[33m:[39m metadata[33m.[39msource_url[33m,[39m[0m

      at ConflictTransformer.transformRecord (scripts/utils/conflict-transformer.js:78:24)
      at scripts/utils/conflict-transformer.js:24:36
          at Array.map (<anonymous>)
      at ConflictTransformer.transform (scripts/utils/conflict-transformer.js:24:8)
      at Object.<anonymous> (tests/transformers.test.js:19:36)

  â— ConflictTransformer â€º should handle missing fields gracefully

    TypeError: Cannot read properties of undefined (reading 'source')

    [0m [90m 76 |[39m       [90m// Provenance[39m
     [90m 77 |[39m       sources[33m:[39m [{
    [31m[1m>[22m[39m[90m 78 |[39m         name[33m:[39m metadata[33m.[39msource [33m||[39m metadata[33m.[39morganization[33m?[39m[33m.[39mtitle [33m||[39m [32m'Unknown'[39m[33m,[39m
     [90m    |[39m                        [31m[1m^[22m[39m
     [90m 79 |[39m         organization[33m:[39m metadata[33m.[39morganization[33m?[39m[33m.[39mtitle [33m||[39m metadata[33m.[39morganization [33m||[39m [32m'Unknown'[39m[33m,[39m
     [90m 80 |[39m         fetched_at[33m:[39m [36mnew[39m [33mDate[39m()[33m.[39mtoISOString()[33m,[39m
     [90m 81 |[39m         url[33m:[39m metadata[33m.[39msource_url[33m,[39m[0m

      at ConflictTransformer.transformRecord (scripts/utils/conflict-transformer.js:78:24)
      at scripts/utils/conflict-transformer.js:24:36
          at Array.map (<anonymous>)
      at ConflictTransformer.transform (scripts/utils/conflict-transformer.js:24:8)
      at Object.<anonymous> (tests/transformers.test.js:36:36)

Test Suites: 2 failed, 2 total
Tests:       3 failed, 4 passed, 7 total
Snapshots:   0 total
Time:        0.688 s, estimated 1 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
